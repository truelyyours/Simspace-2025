**Enter the original filename of the executable downloaded by Gh0st RAT.**

## Background
The process tree investigation showed that the Gh0st RAT executable `svchost_console.exe` spawned `cmd.exe`, which spawned `powershell.exe`, which eventually executed the new executable `OutlookSharing.exe`. Investigation of file creation events shows that `OutlookSharing.exe` was also created by the same `powershell.exe` process that executed it. 
Since PowerShell created and executed `OutlookSharing.exe`, it is useful to take a closer look at the `powershell.exe` process. Investigating network connections made by malicious processes is just as important as investigating its child processes and spawned commands.

This investigation phase requires correlation of multiple event types such as Sysmon network connection logs with Squid proxy logs, or Zeek logs.
# Finding the Original Filename
The following Splunk query shows Sysmon network connection events spawned by `roxanne.farley` and PowerShell with PID `5156`:

```
index=windows host="acc-win10-4" EventCode=3 User="ez\\roxanne.farley" Image="C:\\Windows\\SysWOW64\\WindowsPowerShell\\v1.0\\powershell.exe" ProcessId=5156
```

The query reveals that the PowerShell process initiated a network connection but, unlike the Gh0st RAT communication, it was not directly to the internet. Instead it was routed through the proxy. *The ability of a program to use or not use the configured proxy is known as being "proxy aware".* Proxy aware processes should reach out to the internet through the proxy. Searching for events where a process communicates directly to an external IP address may overlook connections that go through the proxy. Therefore, it is necessary to correlate local network connection logs with corresponding events on the proxy server or network security monitor logs.

One way to correlate this Sysmon connection log with the corresponding proxy log entry is to identify the source port used for this communication and then use that to craft a query against the Squid proxy log. In this case, the source host of the communication is `172.16.6.104` and the source port used was `65374`.Â 

The following Splunk query shows the proxy log entry associated with the interesting network traffic:

```
index=linux sourcetype="squid:access:recommended" src_ip=172.16.6.104 src_port=65374
```

The query returns a single log entry with valuable pieces of information in it. First, the URL provides the original filename of the executable which is `RURAL_HEAT.exe`. It also provides a new malicious external IP address of `66.42.98.220` with an associated hostname of `www.dylerays.tk`.
## Analyst Insight
An interesting piece of intelligence can also be gathered from this information. It seems that the attacker did not rename their executable to `OutlookSharing.exe` before hosting it for download. Instead they downloaded the original file and saved it as `OutlookSharing.exe` in an attempt to blend in on the target system. The format of the original filename is interesting because it matches the naming convention for default payloads that are generated by Sliver, which is an open source C2 framework used for pentesting and adversary emulation.

NEXT: [[Question 4]]
